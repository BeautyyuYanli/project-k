#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = ["httpx"]
# ///

"""Run Jina web search and mirror stdout to a required output file.

`--out` must be a unique path. The script refuses to overwrite existing files to
avoid races across concurrent tool invocations.
"""

import os
import sys
import argparse
import httpx


def _write_stdout_and_file(output: str, out_path: str) -> None:
    """Write exactly the same text to a file and stdout."""
    with open(out_path, "w", encoding="utf-8") as f:
        f.write(output)
    sys.stdout.write(output)

def main():
    parser = argparse.ArgumentParser(description="Web search via Jina AI Search")
    parser.add_argument("query", help="Search query")
    parser.add_argument(
        "--out",
        required=True,
        help="Output file path (must be unique to avoid races)",
    )
    args = parser.parse_args()

    jina_key = os.environ.get("JINA_AI_KEY")
    if not jina_key:
        print("Error: JINA_AI_KEY environment variable not set.", file=sys.stderr)
        sys.exit(1)

    if os.path.exists(args.out):
        print(f"Error: output file already exists: {args.out}", file=sys.stderr)
        print("Use a unique output file name to avoid race conditions.", file=sys.stderr)
        sys.exit(1)

    headers = {
        "Authorization": f"Bearer {jina_key}",
        "Accept": "application/json"
    }
    params = {"q": args.query}
    
    try:
        response = httpx.get("https://s.jina.ai/", params=params, headers=headers, timeout=30.0)
        response.raise_for_status()
        output = response.text

        _write_stdout_and_file(output, args.out)
            
    except Exception as e:
        print(f"Error during search: {e}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
